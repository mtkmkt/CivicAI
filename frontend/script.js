// script.js - FAQ Data for Kothamangalam, Kerala (Detailed Questions)
const faqData = {
  // ---------------- WATER SUPPLY ----------------
  water: [
    {
      q: "Why is there no water in my area today?",
      a: `Water supply interruptions in Kothamangalam can happen due to:
      1. Scheduled Maintenance: Routine pipeline or treatment plant maintenance.
      2. Emergency Repairs: Burst pipes, pump failures, or other unforeseen issues.
      3. Water Shortage: Lower reservoir levels or high seasonal demand.
      For specific information about Kothamangalam, contact: KWA Kothamangalam PH Office at 0485-2822040.`
    },
    {
      q: "What time is the water supply in my locality?",
      a: `Water timings differ by area. To check Kothamangalam schedules:
      1. Call KWA Kothamangalam Office: 0485-2822040.
      2. Visit KWA District Water Page: https://www.kwa.kerala.gov.in
      3. Check local notice boards for updates.`
    },
    {
      q: "How can I check if water supply is scheduled for maintenance?",
      a: `Scheduled maintenance is announced through:
      1. KWA Official Website: https://www.kwa.kerala.gov.in
      2. Local office notice boards in Kothamangalam.
      3. Helpline: 0485-2822040.`
    },
    {
      q: "Who should I contact if there is a water leak in the main pipeline?",
      a: `Report leaks immediately:
      1. Emergency Helpline: 1916 (24/7)
      2. KWA Kothamangalam Office: 0485-2822040
      3. Provide your location and any visible damage details.`
    },
    {
      q: "How can I pay my water bill online?",
      a: `To pay your water bill in Kothamangalam:
      1. Visit KWA Quick Pay: https://www.kwa.kerala.gov.in/quickpay
      2. Enter your Consumer ID / RR Number.
      3. Select payment method (Credit/Debit Card, Net Banking, UPI).
      4. Confirm payment and keep the receipt.
      For help: Call KWA Kothamangalam Office: 0485-2822040.`
    },
    {
      q: "How can I apply for a new water connection?",
      a: `Steps to apply for a new connection in Kothamangalam:
      1. Visit KWA New Water Connection page: https://www.kwa.kerala.gov.in
      2. Download and fill out the application form.
      3. Attach documents: ID proof, property documents.
      4. Submit form online or at KWA Kothamangalam Office: 0485-2822040
      5. Pay applicable fees (check the portal for amounts).`
    },
    {
      q: "How can I report low water pressure in my house?",
      a: `Steps to report low pressure:
      1. Visit KWA Complaint Registration: https://www.kwa.kerala.gov.in/complaints
      2. Fill the form with your details and location.
      3. Alternatively, call helpline: 1916 or KWA Kothamangalam Office: 0485-2822040.`
    }
  ],

  // ---------------- ELECTRICITY ----------------
  electricity: [
    {
      q: "How to report a power outage?",
      a: `For Kothamangalam electricity outage:
      1. Call KSEB Customer Care: 1912
      2. Provide your Consumer Number, address, and problem details.
      3. Optionally, report via KSEB online portal: https://www.kseb.in/online-services
      4. Keep a note of complaint reference number.`
    },
    {
      q: "Who to contact for faulty wiring?",
      a: `For faulty wiring issues:
      1. Call KSEB local office in Kothamangalam: 0485-282XXXX
      2. For emergencies (sparks, exposed wires), immediately call 1912.
      3. Avoid touching wires until the electrician arrives.`
    },
    {
      q: "How can I pay my electricity bill online?",
      a: `Steps to pay online in Kothamangalam:
      1. Go to KSEB Online Payment Portal: https://www.kseb.in/online-services
      2. Enter your Consumer Number.
      3. Click 'Fetch Bill' to see amount.
      4. Select payment method (Credit/Debit, Net Banking, UPI).
      5. Confirm payment and save receipt.
      For issues, call KSEB Customer Care: 1912.`
    },
    {
      q: "What to do if there is a spark or exposed wire?",
      a: `Safety steps:
      1. Stay away from the wire and cordon the area.
      2. Call 1912 immediately for emergency electrical support.
      3. Warn neighbors if nearby.`
    },
    {
      q: "How to request a new electricity connection?",
      a: `Steps for new connection in Kothamangalam:
      1. Visit KSEB New Connection Page: https://www.kseb.in/online-services
      2. Fill the application form online.
      3. Submit required documents: ID, property proof.
      4. Pay applicable fees online or at the local KSEB office.`
    },
    {
      q: "How to check scheduled power cuts?",
      a: `To know scheduled outages:
      1. Check KSEB portal: https://www.kseb.in/outage-schedule
      2. Contact KSEB Kothamangalam local office: 0485-282XXXX
      3. Check local notice boards for updates.`
    },
    {
      q: "How can I check my electricity consumption?",
      a: `Steps to check consumption:
      1. Visit KSEB online portal: https://www.kseb.in/online-services
      2. Log in with Consumer Number.
      3. View current and past bill details and consumption history.`
    }
  ],

  // ---------------- HEALTH ----------------
  health: [
    {
      q: "Where is the nearest hospital?",
      a: `Nearest hospitals in Kothamangalam:
      1. Govt. Taluk Hospital, Kothamangalam — 0485-2821010
      2. General Hospital, Kothamangalam — 0485-2822020
      For emergencies, dial 108.`
    },
    {
      q: "How to book a hospital appointment online?",
      a: `Steps:
      1. Visit Kerala eHealth Portal: https://www.ehealth.kerala.gov.in
      2. Create an account or log in.
      3. Select hospital and department.
      4. Choose date/time and confirm appointment.`
    },
    {
      q: "What to do for a medical emergency?",
      a: `1. Dial 108 immediately.
      2. Provide location and nature of emergency.
      3. Follow operator instructions until help arrives.`
    },
    {
      q: "How can I find a local pharmacy?",
      a: `1. Search on Google Maps for pharmacies in Kothamangalam.
      2. Check with local PHC or municipality for licensed options.
      3. Visit pharmacy with valid prescription if needed.`
    },
    {
      q: "Where can I get COVID-19 vaccination?",
      a: `1. Visit Kerala eHealth Portal: https://www.ehealth.kerala.gov.in
      2. Check nearest vaccination centers in Kothamangalam.
      3. Book appointment online.`
    },
    {
      q: "Who do I contact for ambulance services?",
      a: `1. Dial 108 for government ambulance.
      2. Private ambulance services in Kothamangalam: +91 9497XXXXX
      3. Provide your exact location and patient details.`
    },
    {
      q: "How to report health hazards in the community?",
      a: `1. Contact local PHC Kothamangalam: 0485-2821010
      2. Submit complaint via Kerala Health Dept portal: https://dhs.kerala.gov.in
      3. Provide photos or description of the hazard.`
    }
  ]
};

const API_BASE = 'http://localhost:5050';
let userLocation = { district: '', municipality: '' };

function el(q) { return document.querySelector(q); }

function showPage(id) {
  document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
  const elPage = document.getElementById(id);
  if (elPage) elPage.classList.remove('hidden');
  const baseText = document.getElementById('apiBaseText');
  if (baseText) baseText.textContent = API_BASE;
}

// ----------------- KEYWORD MATCHING FUNCTION -----------------
function findFAQAnswer(message) {
  message = message.toLowerCase();
  for (const category in faqData) {
    for (const item of faqData[category]) {
      const question = item.q.toLowerCase();
      const keywords = question.split(/\W+/).filter(k => k.length > 2);
      const matches = keywords.filter(k => message.includes(k));
      if (matches.length >= Math.max(1, Math.floor(keywords.length / 3))) {
        return item.a;
      }
    }
  }
  return null;
}

// ----------------- CHAT APP -----------------
document.addEventListener('DOMContentLoaded', () => {

  // ------------------ START BUTTON FIX ------------------
  const startBtn = el('#startBtn');
  if (startBtn) {
    startBtn.addEventListener('click', () => {
      const district = el('#districtSelect')?.value;
      const municipality = el('#municipalityInput')?.value.trim();
      if (!district || !municipality) return alert('Choose district and enter municipality.');
      userLocation = { district, municipality };
      showPage('page-choice');
    });
  }

  const chatContainer = el('#chatContainer');
  const queryForm = el('#queryForm');

  function appendChat(who, text) {
    const div = document.createElement('div');
    div.className = 'chat-bubble ' + who;
    div.textContent = text;
    chatContainer.appendChild(div);
    chatContainer.scrollTop = chatContainer.scrollHeight;
  }

  queryForm.addEventListener('submit', async ev => {
    ev.preventDefault();
    const message = el('#queryMessage').value.trim();
    if (!message) return;

    appendChat('user', message);
    el('#queryMessage').value = '';

    const botBubble = document.createElement('div');
    botBubble.className = 'chat-bubble bot';
    botBubble.textContent = '...';
    chatContainer.appendChild(botBubble);
    chatContainer.scrollTop = chatContainer.scrollHeight;

    // Check FAQ first
    const faqAnswer = findFAQAnswer(message);
    if (faqAnswer) {
      botBubble.textContent = faqAnswer;
      return;
    }

    // Otherwise call backend API
    try {
      const res = await fetch(API_BASE + '/api/query', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message, location: userLocation })
      });
      const data = await res.json();
      botBubble.textContent = data.answer || '(Demo) Answer coming soon.';
    } catch (err) {
      botBubble.textContent = `(Demo) Sorry, I could not find a relevant answer.`;
    }
  });

  // ---------- rest of code (login, complaints, FAQ page) remains exactly the same as your previous full code ----------
});
